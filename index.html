<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Energy Management</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg-color: #161b22;
            --text-color: #c9d1d9;
            --heading-color: #f0f6fc;
            --primary-color: #58a6ff;
            --secondary-color: #8b949e;
            --border-color: #30363d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            background-color: transparent;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 1200px;
            margin: 20px auto;
        }

        .section-title {
            color: var(--heading-color);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .metric-card, .control-card, .info-card, .chart-box, .ai-card {
            background-color: var(--card-bg-color);
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .metric-card .label {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--heading-color);
        }
        
        #Power { color: #3fb950; }
        #Current { color: #ffc107; }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            align-items: center;
            padding: 20px 0;
        }
        
        .chart-box canvas { max-width: 100%; }
        .chart-box h5 { color: var(--heading-color); }

        .control-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: left;
        }
        .control-card span {
            font-weight: 500;
            color: var(--heading-color);
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        .ai-card { background-color: rgba(88, 166, 255, 0.1); }
        .ai-card h5 { color: var(--heading-color); }
        .ai-card p { min-height: 50px; }
        .ai-card input[type="text"] {
            width: calc(100% - 70px);
            padding: 10px 15px;
            border-radius: 20px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            margin-right: 10px;
        }
        .ai-card input[type="text"]::placeholder { color: var(--secondary-color); }
        
        /* The two lines that were here have been moved to the <script> block below */

    </style>
</head>
<body>
    <div class="dashboard-container">
        
        <h1 class="section-title text-center" style="color: var(--heading-color);">Smart Energy Management</h1>

        <h2 class="section-title">Real-Time Metrics-project</h2>
        <div class="grid-container">
            <div class="metric-card">
                <div class="label">POWER</div>
                <div class="value" id="Power">---</div>
            </div>
            <div class="metric-card">
                <div class="label">CURRENT</div>
                <div class="value" id="Current">---</div>
            </div>
            <div class="metric-card">
                <div class="label">VOLTAGE</div>
                <div class="value">210.8 V</div>
            </div>
            <div class="metric-card">
                <div class="label">CARBON FOOTPRINT</div>
                <div class="value">20%</div>
            </div>
        </div>

        <h2 class="section-title">Cost and Usage</h2>
        <div class="chart-container">
             <div class="metric-card">
                <div class="label">LIVE COST TODAY</div>
                <div class="value" id="costtoday">---</div>
            </div>
            <div class="metric-card">
                <div class="label">COST THIS MONTH</div>
                <div class="value">₹55,000</div>
            </div>
            <div class="chart-box" style="max-width: 250px; margin: auto;">
                 <canvas id="costChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">Smart Control</h2>
        <div class="grid-container">
            <div class="control-card">
                <span>LIGHT</span>
                <label class="switch">
                    <input type="checkbox" id="ledToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="control-card">
                <span>FAN</span>
                <label class="switch">
                    <input type="checkbox" id="fanToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="control-card">
                <span>PORT</span>
                <label class="switch">
                    <input type="checkbox" id="portToggle">
                    <span class="slider"></span>
                </label>
            </div>
             <div class="control-card">
                <span>SMART BOARD</span>
                <label class="switch">
                    <input type="checkbox">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <h2 class="section-title">Analytics</h2>
        <div class="chart-container">
            <div class="chart-box">
                <h5 class="text-center">E-BILL</h5>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-box">
                <h5 class="text-center">POWER (watts)</h5>
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">AI Integration</h2>
        <div class="chart-container">
            <div class="ai-card">
                <h5>SMART AI INSIGHT</h5>
                <p id="aiInsight">Could not fetch AI insight. Please ensure the backend server is running.</p>
            </div>
            <div class="ai-card">
                <h5>CHAT WITH AI</h5>
                <input type="text" id="userQuestion" placeholder="Ask something...">
                <button id="askBtn" class="btn btn-primary rounded-pill">ASK</button>
                <p id="userAIResponse" class="mt-2"></p>
            </div>
        </div>

        <h2 class="section-title">Help & Support</h2>
        <div class="info-card text-center">
            <p>For assistance or more information, please contact our comprehensive help guide.</p>
            <button type="button" class="btn btn-outline-light rounded-pill">HELP</button>
        </div>

    </div>

    <script>
        // --- CORRECTED: MOVED THE CHART.JS DEFAULTS HERE ---
        // This is JavaScript, so it must be inside a <script> tag.
        Chart.defaults.color = 'var(--text-color)';
        Chart.defaults.borderColor = 'var(--border-color)';
        // ----------------------------------------------------

        const ctx = document.getElementById('costChart').getContext('2d');
        new Chart(ctx, { type: 'pie', data: { labels: ['Grid', 'Solar'], datasets: [{ label: 'Consumption', data: [70, 30], backgroundColor: ['#30363d', '#ffc107'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { labels: { color: 'white' }, position: 'bottom' } } } });

        const barCtx = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart(barCtx, { type: 'bar', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'E-BILL (₹)', data: [1200, 1500, 1100, 1800, 2000, 1750, 1300], backgroundColor: 'rgba(88, 166, 255, 0.8)', borderColor: 'var(--primary-color)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'top' } } } });

        const lineCtx = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(lineCtx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Energy Usage (kWh)', data: [5500, 5800, 5600, 6100, 5900, 6300], backgroundColor: 'rgba(88, 166, 255, 0.2)', borderColor: '#58a6ff', borderWidth: 2, tension: 0.3, fill: true, pointBackgroundColor: '#fff', pointBorderColor: '#58a6ff' }] }, options: { responsive: true, scales: { y: { beginAtZero: false } }, plugins: { legend: { position: 'top' } } } });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_WEB_API_KEY", // Replace with your actual Firebase Web API Key
            authDomain: "test-001-c3444.firebaseapp.com",
            databaseURL: "https://test-001-c3444-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-001-c3444",
            storageBucket: "test-001-c3444.appspot.com",
            messagingSenderId: "885640728034",
            appId: "1:885640728034:web:52d3e85484db18d90a3dbb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        onValue(ref(db, "POWER"), (snapshot) => {
            document.getElementById("Power").innerText = `${snapshot.val() || 0} W`;
        });
        onValue(ref(db, "CURRENT_DATA"), (snapshot) => {
            const current = snapshot.val() || 0;
            document.getElementById("Current").innerText = `${current} A`;
            fetchInsight(current);
        });
        onValue(ref(db, "POWER"), (snapshot) => {
            document.getElementById("costtoday").innerText = `₹ ${snapshot.val() || 0}`;
        });

        function setupToggle(toggleId, dbPath) {
            const toggleElement = document.getElementById(toggleId);
            const dbRef = ref(db, dbPath);
            onValue(dbRef, (snapshot) => { toggleElement.checked = (snapshot.val() === 3); });
            toggleElement.addEventListener("change", function () { set(dbRef, this.checked ? 3 : 0); });
        }
        setupToggle("ledToggle", "LED_STATUS");
        setupToggle("fanToggle", "FAN_STATUS");
        setupToggle("portToggle", "PORT_STATUS");

        const API_SERVER_URL = "http://127.0.0.1:3001";

        async function fetchInsight(current) {
            try {
                const response = await fetch(`${API_SERVER_URL}/api/ai-insight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: `Current campus energy usage is ${current} amperes. Provide a brief, actionable insight for smart energy management.` }),
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                document.getElementById("aiInsight").innerText = data.insight;
            } catch (error) {
                console.error("Error fetching AI insight:", error);
            }
        }

        document.getElementById("askBtn").addEventListener("click", async () => {
            const userQuestion = document.getElementById("userQuestion").value;
            const responseEl = document.getElementById("userAIResponse");
            if (!userQuestion) {
                responseEl.innerText = "Please enter a question.";
                return;
            }
            responseEl.innerText = "Thinking...";
            try {
                const response = await fetch(`${API_SERVER_URL}/api/ai-insight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: userQuestion }),
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                responseEl.innerText = data.insight;
            } catch (error) {
                console.error("Error fetching AI answer:", error);
                responseEl.innerText = "Failed to get an answer. The backend server might be down.";
            }
        });
    </script>
</body>
</html>