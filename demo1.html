<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Energy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
            color: #333;
        }
        .container-main {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 20px;
            max-width: 1400px;
            margin: 20px auto;
        }
        .header {
            border-radius: 15px;
            background-color: rgb(59, 43, 124);
            color: white;
            padding: 10px;
            margin-bottom: 20px;
        }
        h2, h3 {
            font-weight: 600;
        }
        .section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .metric-box, .control-box, .chart-box, .ai-box, .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .metric-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .metric-box {
            flex-basis: 180px;
            flex-grow: 1;
        }
        .metric-box .label {
            font-size: 1rem;
            color: #6c757d;
        }
        .metric-box .value {
            font-size: 2rem;
            font-weight: 700;
            color: #212529;
        }
        .control-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-basis: 220px;
            padding: 15px 25px;
        }
        .chart-box {
            flex-basis: 48%;
            min-width: 300px;
            height: 400px;
        }
        .ai-box {
            flex-basis: 48%;
            text-align: left;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container-main">
        <header class="header">
            <h1 style="text-align: center; font-size: 1.5rem;">Smart Energy Management</h1>
        </header>

        <h2 style="color:rgb(133, 99, 164);">Real-Time Metrics</h2>
        <div class="section">
            <div class="metric-box"><div class="label">POWER</div><div class="value" id="Power">---</div></div>
            <div class="metric-box"><div class="label">CURRENT</div><div class="value" id="Current">---</div></div>
            <div class="metric-box"><div class="label">VOLTAGE</div><div class="value" id="Voltage">---</div></div>
            <div class="metric-box"><div class="label">TOTAL ENERGY</div><div class="value" id="totalEnergySum">---</div></div>
        </div>

        <h2 style="color: rgb(14, 81, 105);">Cost & Usage</h2>
        <div class="section">
            <div class="metric-box"><div class="label">COST TODAY</div><div class="value" id="cost-today">---</div></div>
            <div class="metric-box"><div class="label">COST THIS MONTH</div><div class="value" id="cost-month">---</div></div>
            <div style="flex-basis: 250px; height: 200px;"><canvas id="costSourceChart"></canvas></div>
        </div>

        <h2 style="color: rgb(142, 107, 63);">Smart Controls</h2>
        <div class="section">
            <div class="control-box"><span>LIGHT</span><label class="switch"><input type="checkbox" id="ledToggle"><span class="slider"></span></label></div>
            <div class="control-box"><span>FAN</span><label class="switch"><input type="checkbox" id="fanToggle"><span class="slider"></span></label></div>
            <div class="control-box"><span>PORT</span><label class="switch"><input type="checkbox" id="portToggle"><span class="slider"></span></label></div>
        </div>
        
        <h2 style="color: #226924;">Analytics</h2>
        <div class="section">
            <div class="chart-box"><h3>E-BILL (LAST 7 DAYS)</h3><canvas id="billBarChart"></canvas></div>
            <div class="chart-box"><h3>LIVE POWER (WATTS)</h3><canvas id="powerLineChart"></canvas></div>
        </div>

        <h2>Notifications & Alerts</h2>
        <div class="section">
            <div class="info-box" style="background-color: #fffbe6; border-color: #ffe58f; width: 100%;">
                <h3 id="motionAlert">No motion detected recently.</h3>
            </div>
        </div>

        <h2>AI Integration</h2>
        <div class="section">
            <div class="ai-box">
                <h3>SMART AI INSIGHT</h3>
                <p id="aiInsight">Fetching AI insight...</p>
            </div>
            <div class="ai-box">
                <h3>CHAT WITH AI</h3>
                <input type="text" id="userQuestion" placeholder="Ask something..." style="width: 70%; padding: 10px; border-radius: 20px; border: 1px solid #ccc;">
                <button id="askBtn" style="padding: 10px 15px; border-radius: 20px; border: none; background-color: #5865f2; color: white; cursor: pointer;">Ask</button>
                <p id="userAIResponse" style="margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your key
            authDomain: "test-001-c3444.firebaseapp.com",
            databaseURL: "https://test-001-c3444-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-001-c3444",
            storageBucket: "test-001-c3444.appspot.com",
            messagingSenderId: "885640728034",
            appId: "1:885640728034:web:52d3e85484db18d90a3dbb"
        };
        const API_SERVER_URL = "http://localhost:3001";
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CHART SETUP (Initialized here, data loaded later) ---
        const createChart = (ctx, type, data, options) => new Chart(ctx, { type, data, options });
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        };

        const costSourceChart = createChart(document.getElementById('costSourceChart').getContext('2d'), 'pie', {
            labels: ['Grid', 'Solar'], datasets: [{ data: [70, 30], backgroundColor: ['#5865f2', '#f0b90b'] }]
        }, { responsive: true, maintainAspectRatio: false });

        const billBarChart = createChart(document.getElementById('billBarChart').getContext('2d'), 'bar', {
            labels: [], datasets: [{ label: 'E-BILL (â‚¹)', data: [], backgroundColor: '#5865f2' }]
        }, chartOptions);

        const powerLineChart = createChart(document.getElementById('powerLineChart').getContext('2d'), 'line', {
            labels: [], datasets: [{ label: 'Power (W)', data: [], borderColor: '#f25858', tension: 0.3 }]
        }, chartOptions);

        // --- REAL-TIME FIREBASE LISTENERS ---
        onValue(ref(db, "POWER"), snapshot => {
            const power = snapshot.val() || 0;
            document.getElementById("Power").innerText = `${power.toFixed(2)} W`;
            const current = parseFloat(document.getElementById("Current").innerText) || 0;
            const voltage = current > 0 ? (power / current) : 0;
            document.getElementById("Voltage").innerText = `${voltage.toFixed(2)} V`;
        });

        onValue(ref(db, "CURRENT_DATA"), snapshot => {
            const current = snapshot.val() || 0;
            document.getElementById("Current").innerText = `${current.toFixed(2)} A`;
            fetchInsight(current);
        });
        
        // Motion Sensor Listener
        let lastMotionTime = null;
        onValue(ref(db, "IR_DATA"), (snapshot) => {
            if (snapshot.val() === "HIGH") {
                lastMotionTime = new Date();
                document.getElementById('motionAlert').innerText = 'Motion Detected!';
            }
        });
        setInterval(() => {
            if (lastMotionTime) {
                const diff_s = Math.floor((new Date() - lastMotionTime) / 1000);
                if (diff_s > 5) { // Show "last seen" after 5 seconds
                    document.getElementById('motionAlert').innerText = `Motion last detected ${diff_s} seconds ago.`;
                }
            }
        }, 1000);

        // --- SMART CONTROLS ---
        const setupToggle = (toggleId, dbPath) => {
            const toggleElement = document.getElementById(toggleId);
            const dbRef = ref(db, dbPath);
            onValue(dbRef, (snapshot) => { toggleElement.checked = (snapshot.val() === 3); });
            toggleElement.addEventListener("change", () => { set(dbRef, toggleElement.checked ? 3 : 0); });
        };
        setupToggle("ledToggle", "LED_STATUS");
        setupToggle("fanToggle", "FAN_STATUS");
        setupToggle("portToggle", "PORT_STATUS");

        // --- DATA FETCHING FROM BACKEND API ---

        async function fetchDashboardData() {
            try {
                // Costs
                const costsRes = await fetch(`${API_SERVER_URL}/api/costs`);
                const costsData = await costsRes.json();
                document.getElementById("cost-today").innerText = `â‚¹${costsData.cost_today}`;
                document.getElementById("cost-month").innerText = `â‚¹${costsData.cost_month}`;

                // Total Energy
                const energyRes = await fetch(`${API_SERVER_URL}/api/total-energy`);
                const energyData = await energyRes.json();
                document.getElementById('totalEnergySum').innerText = `${(energyData.totalEnergy / 1000).toFixed(2)} kWh`;

                // Weekly Bill Chart
                const billChartRes = await fetch(`${API_SERVER_URL}/api/charts/weekly-bill`);
                const billChartData = await billChartRes.json();
                billBarChart.data.labels = billChartData.labels;
                billBarChart.data.datasets[0].data = billChartData.data;
                billBarChart.update();

                // Power History Chart
                const powerChartRes = await fetch(`${API_SERVER_URL}/api/charts/power-history`);
                const powerChartData = await powerChartRes.json();
                powerLineChart.data.labels = powerChartData.labels;
                powerLineChart.data.datasets[0].data = powerChartData.data;
                powerLineChart.update();

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
            }
        }

        // --- AI INTEGRATION ---
        async function fetchInsight(current) {
            try {
                const prompt = `Current campus energy usage is ${current.toFixed(2)} amperes. Provide a brief, actionable insight for smart energy management.`;
                const response = await fetch(`${API_SERVER_URL}/api/ai-insight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt }),
                });
                const data = await response.json();
                document.getElementById("aiInsight").innerText = data.insight;
            } catch (error) {
                console.error("Error fetching AI insight:", error);
            }
        }

        document.getElementById("askBtn").addEventListener("click", async () => {
            const userQuestion = document.getElementById("userQuestion").value;
            const responseEl = document.getElementById("userAIResponse");
            if (!userQuestion) return;
            responseEl.innerText = "Thinking...";
            try {
                const response = await fetch(`${API_SERVER_URL}/api/ai-insight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: userQuestion }),
                });
                const data = await response.json();
                responseEl.innerText = data.insight;
            } catch (error) {
                responseEl.innerText = "Failed to get an answer.";
            }
        });
        
        // --- INITIAL LOAD AND REFRESH ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchDashboardData(); // Fetch all data on load
            setInterval(fetchDashboardData, REFRESH_INTERVAL); // Refresh every 30 seconds
        });
    </script>
</body>
</html>